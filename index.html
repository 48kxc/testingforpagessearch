<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>48 Searcher</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #121212;
      color: #fff;
      margin: 0;
      padding: 0;
    }
    #container {
      display: none;
      padding: 20px;
    }
    #loginOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: #000000cc;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    input, button {
      padding: 10px;
      margin: 10px;
      font-size: 16px;
    }
    #adminPanel {
      display: none;
      background: #1e1e1e;
      padding: 20px;
      border-radius: 10px;
    }
    #keyGenerator, #workingKeys {
      margin-top: 20px;
    }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      margin: 5px 0;
      background: #2a2a2a;
      padding: 10px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
    }
    .expireTime {
      color: #bbb;
      font-size: 0.9em;
    }
    #adminBtn {
      display: none;
      position: fixed;
      top: 10px;
      right: 10px;
    }
  </style>
</head>
<body>

<div id="loginOverlay">
  <h2>Enter Access Key or Admin Password</h2>
  <input id="accessKeyInput" type="text" placeholder="Access Key / Admin Password">
  <button id="submitAccessKeyBtn">Submit</button>
  <p id="keyErrorMessage" style="color:red;"></p>
</div>

<div id="container">
  <button id="adminBtn">Admin Panel</button>
  <h1>48 Searcher</h1>
  <!-- Your app content goes here -->
</div>

<div id="adminPanel">
  <input id="adminPassword" type="password" placeholder="Enter Admin Password">
  <button id="loginAdmin">Login as Admin</button>
  <div id="keyGenerator">
    <button id="generateKey">Generate Key</button>
    <p id="newKey"></p>
  </div>
  <div id="workingKeys">
    <h3>Valid Access Keys</h3>
    <ul id="keysList"></ul>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, Timestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDkU4W01OimygxLlEXBhqrba3PglcV2224",
  authDomain: "searcher-key-sys.firebaseapp.com",
  projectId: "searcher-key-sys",
  storageBucket: "searcher-key-sys.firebasestorage.app",
  messagingSenderId: "500491200168",
  appId: "1:500491200168:web:91ae88fa17f8a8bb6f849d"
};

const MASTER_KEY = "48ontop2323";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const keysCollection = collection(db, "accessKeys");

const adminBtn = document.getElementById('adminBtn');
const adminPanel = document.getElementById('adminPanel');
const adminPasswordInput = document.getElementById('adminPassword');
const loginAdminBtn = document.getElementById('loginAdmin');
const keyGeneratorDiv = document.getElementById('keyGenerator');
const generateKeyBtn = document.getElementById('generateKey');
const newKeyDisplay = document.getElementById('newKey');
const workingKeysDiv = document.getElementById('workingKeys');
const keysList = document.getElementById('keysList');

const container = document.getElementById('container');
const loginOverlay = document.getElementById('loginOverlay');
const accessKeyInput = document.getElementById('accessKeyInput');
const submitAccessKeyBtn = document.getElementById('submitAccessKeyBtn');
const keyErrorMessage = document.getElementById('keyErrorMessage');

let loggedIn = false;
let isAdmin = false;

function formatTimestamp(ts) {
  const date = ts.toDate();
  return date.toLocaleString(undefined, {
    year: 'numeric', month: 'short', day: 'numeric',
    hour: '2-digit', minute: '2-digit', second: '2-digit',
    hour12: false
  });
}

async function checkKeyValid(inputKey) {
  if (inputKey === MASTER_KEY) return true;

  const now = new Date();
  const q = query(keysCollection, where("key", "==", inputKey));
  const snapshot = await getDocs(q);

  for (const doc of snapshot.docs) {
    const data = doc.data();
    if (data.expireAt && data.expireAt.toDate() > now) {
      return true;
    }
  }
  return false;
}

async function validateAccessKeyOrPassword(inputKey) {
  return await checkKeyValid(inputKey);
}

async function loadWorkingKeys() {
  keysList.innerHTML = '';
  const now = new Date();
  const snapshot = await getDocs(keysCollection);

  let anyValid = false;
  snapshot.forEach(doc => {
    const data = doc.data();
    if (data.expireAt && data.expireAt.toDate() > now) {
      anyValid = true;
      const expFormatted = formatTimestamp(data.expireAt);
      keysList.innerHTML += `<li><span>${data.key}</span><span class="expireTime">Expires at: ${expFormatted}</span></li>`;
    }
  });

  if (!anyValid) {
    keysList.innerHTML = '<li>No valid keys found.</li>';
  }
}

submitAccessKeyBtn.addEventListener('click', async () => {
  const input = accessKeyInput.value.trim();
  if (!input) {
    keyErrorMessage.textContent = "Please enter an access key or admin password.";
    return;
  }
  keyErrorMessage.textContent = "";
  try {
    const valid = await validateAccessKeyOrPassword(input);
    if (valid) {
      loggedIn = true;
      isAdmin = (input === MASTER_KEY);
      sessionStorage.setItem('accessKey', input);
      initializeAfterLogin();
    } else {
      keyErrorMessage.textContent = "Invalid or expired key/password.";
    }
  } catch (e) {
    keyErrorMessage.textContent = "Error validating key. Please try again.";
    console.error(e);
  }
});

async function initializeAfterLogin() {
  loginOverlay.style.display = 'none';
  container.style.display = 'block';
  adminBtn.style.display = 'block';
}

adminBtn.addEventListener('click', () => {
  adminPanel.style.display = 'block';
  adminPasswordInput.value = '';
  keyGeneratorDiv.style.display = 'none';
  newKeyDisplay.textContent = '';
  workingKeysDiv.style.display = 'none';
  adminPanel.setAttribute('aria-hidden', 'false');
  adminPasswordInput.focus();
});

loginAdminBtn.addEventListener('click', async () => {
  const pw = adminPasswordInput.value.trim();
  if (pw === MASTER_KEY) {
    isAdmin = true;
    keyGeneratorDiv.style.display = 'block';
    workingKeysDiv.style.display = 'block';
    await loadWorkingKeys();
    adminPasswordInput.value = '';
    loginAdminBtn.style.display = 'none';
  } else {
    alert('Invalid admin password.');
  }
});

generateKeyBtn.addEventListener('click', async () => {
  const newKey = Math.random().toString(36).substring(2, 10);
  const expireTime = new Date();
  expireTime.setHours(expireTime.getHours() + 7);

  try {
    await addDoc(keysCollection, {
      key: newKey,
      expireAt: Timestamp.fromDate(expireTime),
      createdAt: serverTimestamp()
    });

    newKeyDisplay.textContent = `New Key: ${newKey}`;
    await loadWorkingKeys();
  } catch (e) {
    console.error("Error generating key:", e);
    newKeyDisplay.textContent = "Failed to generate key.";
  }
});
</script>
</body>
</html>
